<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SUSTC é£Ÿè°±ç³»ç»Ÿ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 24px auto; padding: 0 12px; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 8px 0; }
        input, button, textarea, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { width: 100%; min-height: 90px; }
        .box { border: 1px solid #ddd; padding: 16px; border-radius: 6px; margin: 12px 0; }
        .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .muted { color: #666; font-size: 0.9em; }
        .err { color: #b00; }
        .ok { color: #070; }
        pre { background: #f6f8fa; border: 1px solid #ddd; padding: 12px; overflow: auto; }
        ul { padding-left: 18px; margin: 8px 0; }
        li { margin: 6px 0; cursor: pointer; padding: 4px; }
        li:hover { background: #f0f0f0; }
        .tab { display: none; }
        .tab.active { display: block; }
        .tab-buttons { display: flex; gap: 8px; margin: 16px 0; }
        .tab-button { padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; }
        .tab-button.active { background: #007bff; color: white; }
        .user-info { background: #e8f4fd; padding: 12px; border-radius: 4px; margin: 8px 0; }
        .recipe-item { border: 1px solid #eee; padding: 12px; margin: 8px 0; border-radius: 4px; }
        .comment-item { border-left: 3px solid #007bff; padding: 8px 12px; margin: 8px 0; background: #f9f9f9; }
        .like-btn { background: none; border: none; cursor: pointer; color: #666; }
        .like-btn.liked { color: #e74c3c; }
        .loading { opacity: 0.6; pointer-events: none; }
        .hidden { display: none; }
        /* ç™»å½•/æ³¨å†Œé¡µé¢æ ·å¼ */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
        .auth-form {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .auth-form h3 {
            margin-top: 0;
        }
        .auth-switch {
            margin-top: 15px;
            font-size: 0.9em;
        }
        .auth-switch a {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            align-items: center;
        }
        .pagination button {
            padding: 4px 12px;
        }
        .pagination .current-page {
            font-weight: bold;
            margin: 0 8px;
        }
    </style>
</head>
<body>
<!-- ç™»å½•/æ³¨å†Œé¡µé¢å®¹å™¨ -->
<div id="authPage" class="auth-container">
    <h1>SUSTC é£Ÿè°±ç³»ç»Ÿ</h1>

    <!-- ç™»å½•è¡¨å• -->
    <div id="loginForm" class="auth-form">
        <h3>ç”¨æˆ·ç™»å½•</h3>
        <div class="row" style="justify-content: center;">
            <input id="loginUsername" placeholder="ç”¨æˆ·å" style="width: 250px; margin: 5px 0;" />
        </div>
        <div class="row" style="justify-content: center;">
            <input id="loginPassword" placeholder="å¯†ç " type="password" style="width: 250px; margin: 5px 0;" />
        </div>
        <div class="row" style="justify-content: center;">
            <button id="loginBtn" style="margin: 10px 0;">ç™»å½•</button>
        </div>
        <div class="auth-switch">
            è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a onclick="showRegisterForm()">ç«‹å³æ³¨å†Œ</a>
        </div>
    </div>

    <!-- æ³¨å†Œè¡¨å• -->
    <div id="registerForm" class="auth-form" style="display: none;">
        <h3>ç”¨æˆ·æ³¨å†Œ</h3>
        <div class="row" style="justify-content: center;">
            <input id="regName" placeholder="ç”¨æˆ·å" style="width: 250px; margin: 5px 0;" />
        </div>
        <div class="row" style="justify-content: center;">
            <input id="regPassword" placeholder="å¯†ç " type="password" style="width: 250px; margin: 5px 0;" />
        </div>
        <div class="row" style="justify-content: center;">
            <select id="regGender" style="width: 250px; margin: 5px 0;">
                <option value="">é€‰æ‹©æ€§åˆ«</option>
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
            </select>
        </div>
        <div class="row" style="justify-content: center;">
            <input id="regBirthday" type="date" style="width: 250px; margin: 5px 0;" />
        </div>
        <div class="row" style="justify-content: center;">
            <button id="registerBtn" style="margin: 10px 0;">æ³¨å†Œ</button>
        </div>
        <div class="auth-switch">
            å·²æœ‰è´¦å·ï¼Ÿ<a onclick="showLoginForm()">ç«‹å³ç™»å½•</a>
        </div>
    </div>
</div>

<!-- åˆ—è¡¨æ¨¡æ€æ¡† -->
<div id="listModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; width: 400px; margin: 100px auto; padding: 20px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 id="listModalTitle" style="margin: 0;">åˆ—è¡¨</h3>
            <button onclick="document.getElementById('listModal').style.display='none'" style="border: none; background: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <ul id="listModalContent" style="list-style: none; padding: 0;"></ul>
    </div>
</div>

<!-- åˆ›å»ºé£Ÿè°±æ¨¡æ€æ¡† -->
<div id="createRecipeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; width: 500px; margin: 50px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">åˆ›å»ºæ–°é£Ÿè°±</h3>
            <button onclick="document.getElementById('createRecipeModal').style.display='none'" style="border: none; background: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="auth-form" style="margin: 0; border: none; padding: 0; background: none;">
            <div class="row">
                <label style="width: 80px;">æ ‡é¢˜:</label>
                <input id="newRecipeTitle" style="flex: 1;" placeholder="é£Ÿè°±æ ‡é¢˜" />
            </div>
            <div class="row">
                <label style="width: 80px;">åˆ†ç±»:</label>
                <select id="newRecipeCategory" style="flex: 1;">
                    <option value="ä¸­é¤">ä¸­é¤</option>
                    <option value="è¥¿é¤">è¥¿é¤</option>
                    <option value="æ—¥æ–™">æ—¥æ–™</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="row">
                <label style="width: 80px;">æè¿°:</label>
                <textarea id="newRecipeDesc" style="flex: 1;" placeholder="é£Ÿè°±æè¿°"></textarea>
            </div>
            <div class="row">
                <label style="width: 80px;">é£Ÿæ:</label>
                <textarea id="newRecipeIngredients" style="flex: 1;" placeholder="é£Ÿæåˆ—è¡¨ï¼Œç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”"></textarea>
            </div>
            <div class="row">
                <label style="width: 80px;">å¡è·¯é‡Œ:</label>
                <input id="newRecipeCalories" type="number" style="flex: 1;" placeholder="å¯é€‰" />
            </div>
            <div class="row">
                <label style="width: 80px;">çƒ¹é¥ªæ—¶é—´:</label>
                <input id="newRecipeCookTime" style="flex: 1;" placeholder="ä¾‹å¦‚: 30åˆ†é’Ÿ (å¯é€‰)" />
            </div>
            <div class="row" style="justify-content: flex-end; margin-top: 20px;">
                <button onclick="submitRecipe()" style="background: #007bff; color: white; border: none; padding: 8px 20px;">æäº¤</button>
            </div>
        </div>
    </div>
</div>

<!-- ä¸»èœå•å®¹å™¨ -->
<div id="mainMenu" style="display: none;">
    <!-- è®¤è¯åŒºåŸŸ -->
    <div class="box" id="authBox">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div id="userInfo" class="user-info">
            <div class="row">
                <b>å½“å‰ç”¨æˆ·:</b>
                <span id="currentUserName">-</span>
                <span id="currentUserId">-</span>
            </div>
            <div class="row">
                <input id="updateGender" placeholder="æ–°æ€§åˆ« (å¯é€‰)" />
                <input id="updateAge" placeholder="æ–°å¹´é¾„ (å¯é€‰)" type="number" />
                <button id="updateProfileBtn">æ›´æ–°èµ„æ–™</button>
                <button id="deleteAccountBtn" class="err">åˆ é™¤è´¦æˆ·</button>
            </div>
            <div class="row">
                <button onclick="showFollowingList()">æˆ‘çš„å…³æ³¨</button>
                <button onclick="showFollowersList()">æˆ‘çš„ç²‰ä¸</button>
                <button onclick="clearRecipeCache()" style="margin-left: 10px;">æ¸…é™¤æœ¬åœ°ç¼“å­˜</button>
            </div>
        </div>
        <div class="row">
            <span id="authStatus" class="ok">å·²ç™»å½•</span>
            <button id="logoutBtn">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="recipes">é£Ÿè°±ç®¡ç†</button>
        <button class="tab-button" data-tab="users">ç”¨æˆ·ç®¡ç†</button>
        <button class="tab-button" data-tab="feed">åŠ¨æ€æµ</button>
        <button class="tab-button" data-tab="api">APIæµ‹è¯•</button>
    </div>

    <!-- é£Ÿè°±ç®¡ç†æ ‡ç­¾é¡µ -->
    <div id="recipes" class="tab active">
        <div class="cols">
            <div class="box">
                <h3>é£Ÿè°±åˆ—è¡¨</h3>
                <div class="row">
                    <input id="query" placeholder="æœç´¢å…³é”®å­—" />
                    <select id="category">
                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                        <option value="ä¸­é¤">ä¸­é¤</option>
                        <option value="è¥¿é¤">è¥¿é¤</option>
                        <option value="æ—¥æ–™">æ—¥æ–™</option>
                    </select>
                    <select id="sortOrder">
                        <option value="date_desc">å‘å¸ƒæ—¶é—´é™åº</option>
                        <option value="id_desc">ID é™åº</option>
                        <option value="id_asc">ID å‡åº</option>
                        <option value="rating_desc">è¯„åˆ†é™åº</option>
                    </select>
                    <button id="searchBtn">æœç´¢</button>
                    <button id="createRecipeBtn">åˆ›å»ºæ–°é£Ÿè°±</button>
                </div>
                <div class="row">
                    <input id="searchRecipeIdInput" placeholder="è¾“å…¥é£Ÿè°±IDç›´è¾¾" type="number" style="width: 150px;" />
                    <button id="searchRecipeIdBtn">æŒ‰IDæŸ¥æ‰¾</button>
                </div>
                <ul id="recipeList"></ul>
                <!-- åˆ†é¡µæ§åˆ¶ -->
                <div class="pagination">
                    <button id="prevPageBtn">ä¸Šä¸€é¡µ</button>
                    <span class="current-page">ç¬¬ <span id="currentPage">1</span> é¡µ / å…± <span id="totalPages">1</span> é¡µ</span>
                    <button id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
                    <select id="pageSizeSelect">
                        <option value="10">10æ¡/é¡µ</option>
                        <option value="20" selected>20æ¡/é¡µ</option>
                        <option value="50">50æ¡/é¡µ</option>
                    </select>
                </div>
            </div>

            <div class="box">
                <h3>é£Ÿè°±è¯¦æƒ…</h3>
                <div id="recipeDetail">
                    <div class="muted">è¯·é€‰æ‹©é£Ÿè°±æŸ¥çœ‹è¯¦æƒ…</div>
                </div>

                <div style="margin-top: 16px;">
                    <h4>è¯„è®ºç®¡ç†</h4>
                    <ul id="commentList"></ul>

                    <div style="margin-top: 12px;">
                        <textarea id="commentContent" placeholder="å†™è¯„è®º..."></textarea>
                        <div class="row">
                            <select id="commentRating">
                                <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
                                <option value="4">â˜…â˜…â˜…â˜…</option>
                                <option value="3">â˜…â˜…â˜…</option>
                                <option value="2">â˜…â˜…</option>
                                <option value="1">â˜…</option>
                            </select>
                            <button id="postCommentBtn">å‘è¡¨è¯„è®º</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
    <div id="users" class="tab">
        <div class="cols">
            <div class="box">
                <h3>ç”¨æˆ·æœç´¢</h3>
                <div class="row">
                    <input id="searchUserId" placeholder="ç”¨æˆ·ID" type="number" />
                    <button id="searchUserBtn">æœç´¢ç”¨æˆ·</button>
                </div>
                <div id="searchedUser" class="user-info"></div>
            </div>
        </div>
    </div>

    <!-- åŠ¨æ€æµæ ‡ç­¾é¡µ -->
    <div id="feed" class="tab">
        <div class="box">
            <h3>åŠ¨æ€æµ</h3>
            <div class="row">
                <select id="feedCategory">
                    <option value="">æ‰€æœ‰åˆ†ç±»</option>
                    <option value="ä¸­é¤">ä¸­é¤</option>
                    <option value="è¥¿é¤">è¥¿é¤</option>
                    <option value="æ—¥æ–™">æ—¥æ–™</option>
                </select>
                <button id="refreshFeedBtn">åˆ·æ–°</button>
            </div>
            <ul id="feedList"></ul>
        </div>
    </div>

    <!-- APIæµ‹è¯•æ ‡ç­¾é¡µ -->
    <div id="api" class="tab">
        <div class="box">
            <h3>APIæµ‹è¯•</h3>
            <div class="row">
                <input id="apiEndpoint" placeholder="APIç«¯ç‚¹ (å¦‚: /ui/recipes)" value="/ui/recipes" />
                <select id="apiMethod">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <button id="testApiBtn">æµ‹è¯•</button>
            </div>
            <div>
                <h4>è¯·æ±‚ä½“:</h4>
                <textarea id="apiRequestBody" placeholder='è¯·æ±‚ä½“ (JSONæ ¼å¼)'></textarea>
            </div>
            <div>
                <h4>å“åº”:</h4>
                <pre id="apiResponse">è¯·ç‚¹å‡»æµ‹è¯•æŒ‰é’®å‘é€è¯·æ±‚</pre>
            </div>
        </div>
    </div>
</div>

<script>
    // é¡µé¢å…ƒç´ 
    let elements = {};

    // å…¨å±€å˜é‡
    let token = localStorage.getItem('ui_token') || '';
    let currentUser = null;
    let currentRecipeId = null;
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let totalItems = 0;
    let recipeCache = new Map(); // å‰ç«¯ç¼“å­˜

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(timestamp) {
        if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
        // å°è¯•è½¬ä¸ºæ•°å­—
        const num = Number(timestamp);
        const date = new Date(isNaN(num) ? timestamp : num);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // APIè°ƒç”¨å‡½æ•°
    async function callApi(url, options = {}) {
        const headers = {
            ...options.headers
        };

        if (options.body) {
            headers['Content-Type'] = 'application/json';
        }

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        try {
            const response = await fetch(url, {
                ...options,
                headers
            });
            return await response.json();
        } catch (error) {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);
            throw error;
        }
    }

    // æ˜¾ç¤ºç™»å½•è¡¨å•
    function showLoginForm() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
    }

    // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
    function showRegisterForm() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    }

    // ç™»å½•
    async function login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
            return;
        }

        try {
            const data = await callApi('/ui/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (data.ok && data.token) {
                token = data.token;
                localStorage.setItem('ui_token', token);
                document.getElementById('authPage').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'block';
                await loadCurrentUserInfo();
                await loadRecipes();
            } else {
                alert('ç™»å½•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('ç™»å½•å¤±è´¥: ' + error.message);
        }
    }

    // æ³¨å†Œ
    async function register() {
        const name = document.getElementById('regName').value.trim();
        const password = document.getElementById('regPassword').value;
        const gender = document.getElementById('regGender').value;
        const birthday = document.getElementById('regBirthday').value;

        if (!name || !password) {
            alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
            return;
        }

        try {
            const data = await callApi('/ui/auth/register', {
                method: 'POST',
                body: JSON.stringify({
                    username: name,
                    name: name,
                    password: password,
                    gender: gender ? gender.toUpperCase() : null,
                    birthday: birthday
                })
            });

            if (data.ok) {
                alert('æ³¨å†ŒæˆåŠŸ! è¯·ç™»å½•');
                showLoginForm();
            } else {
                alert('æ³¨å†Œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('æ³¨å†Œå¤±è´¥: ' + error.message);
        }
    }

    // è§£æè‡ªå®šä¹‰Token
    function parseToken(token) {
        try {
            const parts = token.split('.');
            if (parts.length !== 2) return null;

            // Base64Urlè¿˜åŸä¸ºBase64
            let base64 = parts[0].replace(/-/g, '+').replace(/_/g, '/');
            // è¡¥å…¨padding
            while (base64.length % 4) {
                base64 += '=';
            }

            const decoded = atob(base64);
            const [userId, exp] = decoded.split(':');

            if (!userId || !exp) return null;

            return {
                userId: userId,
                exp: parseInt(exp)
            };
        } catch (e) {
            console.error('Tokenè§£æå¤±è´¥:', e);
            return null;
        }
    }

    // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
    async function loadCurrentUserInfo() {
        if (!token) return;

        try {
            const payload = parseToken(token);
            if (!payload) return;

            const userId = payload.userId;

            const data = await callApi(`/ui/users/${userId}`);
            if (data.ok) {
                currentUser = data.user;
                document.getElementById('currentUserName').textContent = currentUser.name || currentUser.username || 'ç”¨æˆ·' + currentUser.id;
                document.getElementById('currentUserId').textContent = 'ID: ' + currentUser.id;
                document.getElementById('userInfo').style.display = 'block';
            }
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    // é€€å‡ºç™»å½•
    function logout() {
        token = '';
        currentUser = null;
        localStorage.removeItem('ui_token');
        // éšè—ä¸»èœå•ï¼Œæ˜¾ç¤ºç™»å½•/æ³¨å†Œé¡µé¢
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('authPage').style.display = 'block';
        // é‡ç½®ç™»å½•è¡¨å•
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
    }

    // æ›´æ–°ç”¨æˆ·èµ„æ–™
    async function updateProfile() {
        if (!token) return;

        const gender = document.getElementById('updateGender').value.trim();
        const age = document.getElementById('updateAge').value.trim();

        if (!gender && !age) {
            alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªè¦æ›´æ–°çš„å­—æ®µ');
            return;
        }

        const updateData = {};
        if (gender) updateData.gender = gender;
        if (age) updateData.age = parseInt(age);

        try {
            const data = await callApi('/ui/users/profile', {
                method: 'PUT',
                body: JSON.stringify(updateData)
            });

            if (data.ok) {
                alert('èµ„æ–™æ›´æ–°æˆåŠŸ!');
                // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                await loadCurrentUserInfo();
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('updateGender').value = '';
                document.getElementById('updateAge').value = '';
            } else {
                alert('èµ„æ–™æ›´æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('èµ„æ–™æ›´æ–°å¤±è´¥: ' + error.message);
        }
    }

    // åˆ é™¤è´¦æˆ·
    async function deleteAccount() {
        if (!token || !confirm('ç¡®å®šè¦åˆ é™¤è´¦æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }

        try {
            const data = await callApi(`/ui/users/${currentUser.id}`, {
                method: 'DELETE'
            });

            if (data.ok) {
                alert('è´¦æˆ·åˆ é™¤æˆåŠŸ!');
                logout();
            } else {
                alert('è´¦æˆ·åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('è´¦æˆ·åˆ é™¤å¤±è´¥: ' + error.message);
        }
    }

    // è·å–æ‰€æœ‰é£Ÿè°±åˆ†ç±»
    async function loadCategories() {
        try {
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥è°ƒç”¨è·å–åˆ†ç±»çš„API
            // æš‚æ—¶ä½¿ç”¨æœç´¢åŠŸèƒ½æ¥è·å–æ‰€æœ‰åˆ†ç±»
            const data = await callApi('/ui/recipes?page=1&pageSize=1000');
            const categories = new Set();

            (data.items || []).forEach(recipe => {
                if (recipe.category) {
                    categories.add(recipe.category);
                }
            });

            // æ›´æ–°åˆ†ç±»ä¸‹æ‹‰æ¡†
            const categorySelect = document.getElementById('category');
            // ä¿ç•™ç¬¬ä¸€ä¸ª"æ‰€æœ‰åˆ†ç±»"é€‰é¡¹
            const allOption = categorySelect.querySelector('option[value=""]');
            categorySelect.innerHTML = '';
            categorySelect.appendChild(allOption);

            // æ·»åŠ æ‰€æœ‰å®é™…å­˜åœ¨çš„åˆ†ç±»
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            // åŒæ ·æ›´æ–°åŠ¨æ€æµçš„åˆ†ç±»ä¸‹æ‹‰æ¡†
            const feedCategorySelect = document.getElementById('feedCategory');
            const feedAllOption = feedCategorySelect.querySelector('option[value=""]');
            feedCategorySelect.innerHTML = '';
            feedCategorySelect.appendChild(feedAllOption);

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                feedCategorySelect.appendChild(option);
            });

        } catch (error) {
            console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        }
    }

    // åŠ è½½é£Ÿè°±åˆ—è¡¨
    async function loadRecipes() {
        const query = document.getElementById('query').value.trim();
        const category = document.getElementById('category').value;
        const sort = document.getElementById('sortOrder').value;

        let url = `/ui/recipes?page=${currentPage}&pageSize=${pageSize}`;
        if (query) url += '&q=' + encodeURIComponent(query);
        if (category) url += '&category=' + encodeURIComponent(category);
        if (sort) url += '&sort=' + encodeURIComponent(sort);

        try {
            const data = await callApi(url);
            const recipeList = document.getElementById('recipeList');
            recipeList.innerHTML = '';

            (data.items || []).forEach(recipe => {
                const li = document.createElement('li');
                li.className = 'recipe-item';
                li.innerHTML = `
                        <strong>${recipe.title}</strong> (ID: ${recipe.id})<br>
                        <span class="muted">ä½œè€…: ${recipe.author} | åˆ†ç±»: ${recipe.category} | è¯„åˆ†: ${recipe.rating || 'æ— '} | æ—¶é—´: ${formatDate(recipe.createdAt)}</span>
                    `;
                li.onclick = () => selectRecipe(recipe.id);
                recipeList.appendChild(li);
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            totalItems = data.total || 0;
            totalPages = Math.ceil(totalItems / pageSize);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;

            // å¯ç”¨/ç¦ç”¨åˆ†é¡µæŒ‰é’®
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;

        } catch (error) {
            alert('åŠ è½½é£Ÿè°±å¤±è´¥: ' + error.message);
        }
    }

    // æ˜¾ç¤ºå…³æ³¨åˆ—è¡¨
    async function showFollowingList() {
        if (!currentUser) return;
        try {
            const data = await callApi(`/ui/users/${currentUser.id}/following`);
            if (data.ok) {
                showListModal('æˆ‘çš„å…³æ³¨', data.items);
            } else {
                alert('è·å–å…³æ³¨åˆ—è¡¨å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            alert('è·å–å…³æ³¨åˆ—è¡¨å¤±è´¥: ' + error.message);
        }
    }

    // æ˜¾ç¤ºç²‰ä¸åˆ—è¡¨
    async function showFollowersList() {
        if (!currentUser) return;
        try {
            const data = await callApi(`/ui/users/${currentUser.id}/followers`);
            if (data.ok) {
                showListModal('æˆ‘çš„ç²‰ä¸', data.items);
            } else {
                alert('è·å–ç²‰ä¸åˆ—è¡¨å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            alert('è·å–ç²‰ä¸åˆ—è¡¨å¤±è´¥: ' + error.message);
        }
    }

    // æ˜¾ç¤ºåˆ—è¡¨æ¨¡æ€æ¡†
    function showListModal(title, items) {
        document.getElementById('listModalTitle').textContent = title;
        const list = document.getElementById('listModalContent');
        list.innerHTML = '';

        if (!items || items.length === 0) {
            list.innerHTML = '<li class="muted">æš‚æ— æ•°æ®</li>';
        } else {
            items.forEach(item => {
                const li = document.createElement('li');
                li.style.padding = '8px';
                li.style.borderBottom = '1px solid #eee';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.innerHTML = `
                    <span>${item.name} (ID: ${item.id})</span>
                    <button onclick="searchUserById(${item.id}); document.getElementById('listModal').style.display='none'">æŸ¥çœ‹</button>
                `;
                list.appendChild(li);
            });
        }

        document.getElementById('listModal').style.display = 'block';
    }

    // æ¸…é™¤é£Ÿè°±ç¼“å­˜
    function clearRecipeCache() {
        let count = 0;
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('recipe_detail_')) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => {
            localStorage.removeItem(key);
            count++;
        });
        alert(`å·²æ¸…é™¤ ${count} æ¡é£Ÿè°±ç¼“å­˜`);
    }

    // æ˜¾ç¤ºåˆ›å»ºé£Ÿè°±æ¨¡æ€æ¡†
    function showCreateRecipeModal() {
        document.getElementById('newRecipeTitle').value = '';
        document.getElementById('newRecipeDesc').value = '';
        document.getElementById('newRecipeIngredients').value = '';
        document.getElementById('newRecipeCalories').value = '';
        document.getElementById('newRecipeCookTime').value = '';
        document.getElementById('createRecipeModal').style.display = 'block';
    }

    // æäº¤æ–°é£Ÿè°±
    async function submitRecipe() {
        const title = document.getElementById('newRecipeTitle').value.trim();
        const category = document.getElementById('newRecipeCategory').value;
        const description = document.getElementById('newRecipeDesc').value.trim();
        const ingredients = document.getElementById('newRecipeIngredients').value.trim();
        const calories = document.getElementById('newRecipeCalories').value.trim();
        const cookTime = document.getElementById('newRecipeCookTime').value.trim();

        if (!title || !description || !ingredients) {
            alert('æ ‡é¢˜ã€æè¿°å’Œé£Ÿæä¸èƒ½ä¸ºç©º');
            return;
        }

        try {
            const body = {
                title,
                category,
                description,
                ingredients,
                calories: calories ? parseFloat(calories) : null,
                cookTime: cookTime || null
            };

            const data = await callApi('/ui/recipes', {
                method: 'POST',
                body: JSON.stringify(body)
            });

            if (data.ok) {
                alert('é£Ÿè°±åˆ›å»ºæˆåŠŸ!');
                document.getElementById('createRecipeModal').style.display = 'none';
                // åˆ·æ–°åˆ—è¡¨
                currentPage = 1;
                loadRecipes();
            } else {
                alert('åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('åˆ›å»ºå¤±è´¥: ' + error.message);
        }
    }

    // é€šè¿‡IDæœç´¢ç”¨æˆ·ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
    function searchUserById(id) {
        document.getElementById('searchUserId').value = id;
        switchTab('users');
        searchUser();
    }

    // é€‰æ‹©é£Ÿè°±
    async function selectRecipe(id) {
        currentRecipeId = id;
        const cacheKey = 'recipe_detail_' + id;

        try {
            let recipe;
            let fromCache = false;

            // æ£€æŸ¥localStorageç¼“å­˜
            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    recipe = JSON.parse(cachedData);
                    console.log('ä½¿ç”¨ç¼“å­˜åŠ è½½é£Ÿè°±:', id);
                    fromCache = true;
                } catch (e) {
                    console.error('ç¼“å­˜è§£æå¤±è´¥', e);
                    localStorage.removeItem(cacheKey);
                }
            }

            if (!recipe) {
                const data = await callApi(`/ui/recipes/${id}`);
                if (data.ok) {
                    recipe = data.recipe;
                    // å†™å…¥localStorageç¼“å­˜
                    try {
                        localStorage.setItem(cacheKey, JSON.stringify(recipe));
                    } catch (e) {
                        console.warn('ç¼“å­˜å†™å…¥å¤±è´¥(å¯èƒ½æ˜¯ç©ºé—´å·²æ»¡):', e);
                    }
                } else {
                    document.getElementById('recipeDetail').innerHTML = '<div class="err">æ— æ³•åŠ è½½é£Ÿè°±è¯¦æƒ…</div>';
                    return;
                }
            }

            const cacheBadge = fromCache ? '<span style="font-size: 0.8em; color: green; border: 1px solid green; padding: 2px 4px; border-radius: 4px; margin-left: 8px;">å·²ç¼“å­˜</span>' : '';

            document.getElementById('recipeDetail').innerHTML = `
                    <h3>${recipe.title} ${cacheBadge}</h3>
                    <div class="row">
                        <b>é£Ÿè°±ID:</b> ${recipe.id}<br>
                        <b>ä½œè€…:</b> ${recipe.author} (ID: ${recipe.authorId})<br>
                        <b>åˆ†ç±»:</b> ${recipe.category}<br>
                        <b>è¯„åˆ†:</b> ${recipe.rating || 'æ— '}<br>
                        <b>åˆ›å»ºæ—¶é—´:</b> ${formatDate(recipe.createdAt)}
                    </div>
                    <div style="margin: 12px 0;">
                        <h4>æè¿°:</h4>
                        <p>${recipe.description}</p>
                    </div>
                    <div>
                        <h4>é£Ÿæ:</h4>
                        <p>${recipe.ingredients}</p>
                    </div>
                `;

            // åŠ è½½è¯„è®º
            loadComments(id);
        } catch (error) {
            document.getElementById('recipeDetail').innerHTML = '<div class="err">åŠ è½½é£Ÿè°±è¯¦æƒ…å¤±è´¥</div>';
            console.error('åŠ è½½é£Ÿè°±è¯¦æƒ…å¤±è´¥:', error);
        }
    }

    // åŠ è½½è¯„è®º
    async function loadComments(recipeId) {
        try {
            const data = await callApi(`/ui/recipes/${recipeId}/comments`);
            const commentList = document.getElementById('commentList');
            commentList.innerHTML = '';

            if (data.comments && data.comments.length > 0) {
                data.comments.forEach(comment => {
                    const li = document.createElement('li');
                    li.className = 'comment-item';
                    li.innerHTML = `
                            <div class="row">
                                <b>${comment.authorName} (ID: ${comment.authorId})</b>
                                <span class="muted">${formatDate(comment.createdAt)}</span>
                                <button class="like-btn ${comment.liked ? 'liked' : ''}" onclick="likeComment(${comment.id}, ${comment.liked === true})">
                                    ${comment.liked ? 'â¤ï¸' : 'ğŸ¤'} ${comment.likes}
                                </button>
                            </div>
                            <div>è¯„åˆ†: ${comment.rating}â˜…</div>
                            <div>${comment.content}</div>
                        `;
                    commentList.appendChild(li);
                });
            } else {
                commentList.innerHTML = '<li class="muted">æš‚æ— è¯„è®º</li>';
            }
        } catch (error) {
            console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
            document.getElementById('commentList').innerHTML = '<li class="err">åŠ è½½è¯„è®ºå¤±è´¥</li>';
        }
    }

    // ç‚¹èµ/å–æ¶ˆç‚¹èµè¯„è®º
    async function likeComment(commentId, isLiked) {
        console.log('likeComment called:', commentId, isLiked, typeof isLiked);
        try {
            const url = isLiked
                ? `/ui/comments/${commentId}/unlike`
                : `/ui/comments/${commentId}/like`;

            console.log('Requesting URL:', url);

            const data = await callApi(url, {
                method: 'POST'
            });

            if (data.ok) {
                // é‡æ–°åŠ è½½å½“å‰é£Ÿè°±çš„è¯„è®º
                if (currentRecipeId) {
                    loadComments(currentRecipeId);
                }
            } else {
                alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('æ“ä½œå¤±è´¥:', error);
            alert('æ“ä½œå¤±è´¥: ' + error.message);
        }
    }

    // å‘è¡¨è¯„è®º
    async function postComment() {
        if (!currentRecipeId) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé£Ÿè°±');
            return;
        }

        const content = document.getElementById('commentContent').value.trim();
        const rating = document.getElementById('commentRating').value;

        if (!content) {
            alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
            return;
        }

        try {
            const data = await callApi(`/ui/recipes/${currentRecipeId}/comments`, {
                method: 'POST',
                body: JSON.stringify({ content, rating: parseInt(rating) })
            });

            if (data.ok) {
                alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
                document.getElementById('commentContent').value = '';
                loadComments(currentRecipeId);
            } else {
                alert('è¯„è®ºå‘è¡¨å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            alert('è¯„è®ºå‘è¡¨å¤±è´¥: ' + error.message);
        }
    }

    // æœç´¢ç”¨æˆ·
    async function searchUser() {
        const userId = document.getElementById('searchUserId').value.trim();
        if (!userId) {
            alert('è¯·è¾“å…¥ç”¨æˆ·ID');
            return;
        }

        try {
            const data = await callApi(`/ui/users/${userId}`);
            if (data.ok) {
                const user = data.user;
                document.getElementById('searchedUser').innerHTML = `
                        <div class="row">
                            <b>ç”¨æˆ·å:</b> ${user.name}
                            <b>ID:</b> ${user.id}
                        </div>
                        <div class="row">
                            <b>æ€§åˆ«:</b> ${user.gender || 'æœªè®¾ç½®'}
                            <b>å¹´é¾„:</b> ${user.age || 'æœªè®¾ç½®'}
                        </div>
                        <div class="row">
                            <b>å…³æ³¨æ•°:</b> ${user.following}
                            <b>ç²‰ä¸æ•°:</b> ${user.followers}
                        </div>
                        <div class="row">
                            <button onclick="followUser(${user.id})">å…³æ³¨</button>
                        </div>
                    `;
            } else {
                document.getElementById('searchedUser').innerHTML = '<div class="err">ç”¨æˆ·ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®</div>';
            }
        } catch (error) {
            alert('æœç´¢ç”¨æˆ·å¤±è´¥: ' + error.message);
        }
    }

    // å…³æ³¨ç”¨æˆ·
    async function followUser(userId) {
        try {
            const data = await callApi(`/ui/users/${userId}/follow`, {
                method: 'POST'
            });

            if (data.ok) {
                alert('å…³æ³¨æˆåŠŸï¼');
                // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                loadCurrentUserInfo();
            } else {
                alert('å…³æ³¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('å…³æ³¨å¤±è´¥: ' + error.message);
        }
    }

    // åŠ è½½åŠ¨æ€æµ
    async function loadFeed() {
        const category = document.getElementById('feedCategory').value;

        let url = '/ui/feed?page=1&size=20';
        if (category) {
            url += '&category=' + encodeURIComponent(category);
        }

        try {
            const data = await callApi(url);
            const feedList = document.getElementById('feedList');
            feedList.innerHTML = '';

            (data.feed || []).forEach(item => {
                const li = document.createElement('li');
                li.className = 'recipe-item';
                li.innerHTML = `
                        <strong>${item.name}</strong><br>
                        <span class="muted">ä½œè€…: ${item.authorName} (ID: ${item.authorId}) | è¯„åˆ†: ${item.aggregatedRating || 'æ— '} | æ—¶é—´: ${formatDate(item.datePublished)}</span>
                    `;
                li.onclick = () => selectRecipe(item.recipeId);
                feedList.appendChild(li);
            });
        } catch (error) {
            alert('åŠ è½½åŠ¨æ€æµå¤±è´¥: ' + error.message);
        }
    }

    // æµ‹è¯•API
    async function testApi() {
        const endpoint = document.getElementById('apiEndpoint').value.trim();
        const method = document.getElementById('apiMethod').value;
        const requestBody = document.getElementById('apiRequestBody').value.trim();

        if (!endpoint) {
            alert('è¯·è¾“å…¥APIç«¯ç‚¹');
            return;
        }

        try {
            const options = {
                method: method
            };

            if (requestBody) {
                options.body = requestBody;
            }

            const data = await callApi(endpoint, options);
            document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
        } catch (error) {
            document.getElementById('apiResponse').textContent = 'é”™è¯¯: ' + error.message;
        }
    }

    // ä¸Šä¸€é¡µ
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            loadRecipes();
        }
    }

    // ä¸‹ä¸€é¡µ
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            loadRecipes();
        }
    }

    // æ”¹å˜æ¯é¡µå¤§å°
    function changePageSize() {
        pageSize = parseInt(document.getElementById('pageSizeSelect').value);
        currentPage = 1;
        loadRecipes();
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
        // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
        document.getElementById(tabName).classList.add('active');

        // æ·»åŠ é€‰ä¸­æŒ‰é’®çš„activeç±»
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”å†…å®¹
        if (tabName === 'feed') {
            loadFeed();
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    window.addEventListener('load', () => {
        // åˆå§‹åŒ–å…ƒç´ å¼•ç”¨
        elements = {
            currentUserName: document.getElementById('currentUserName'),
            currentUserId: document.getElementById('currentUserId'),
            userInfo: document.getElementById('userInfo'),
            logoutBtn: document.getElementById('logoutBtn'),
            authStatus: document.getElementById('authStatus'),
            recipeList: document.getElementById('recipeList')
        };

        // åŠ è½½åˆ†ç±»
        if (token) {
            loadCategories();
        }

        if (token) {
            // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
            const payload = parseToken(token);

            if (payload) {
                const exp = payload.exp;
                const now = Date.now() / 1000;

                if (exp > now) {
                    // tokenæœ‰æ•ˆï¼Œç›´æ¥è¿›å…¥ä¸»èœå•
                    document.getElementById('authPage').style.display = 'none';
                    document.getElementById('mainMenu').style.display = 'block';
                    loadCurrentUserInfo();
                    loadRecipes();
                    loadCategories();
                } else {
                    // tokenè¿‡æœŸ
                    console.log('Tokenå·²è¿‡æœŸ');
                    token = '';
                    localStorage.removeItem('ui_token');
                }
            } else {
                // tokenæ ¼å¼é”™è¯¯
                console.log('Tokenæ ¼å¼é”™è¯¯');
                token = '';
                localStorage.removeItem('ui_token');
            }
        }
    });

    // äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', () => {
        // ç™»å½•å’Œæ³¨å†Œ
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);

        // ç”¨æˆ·ç®¡ç†
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('updateProfileBtn').addEventListener('click', updateProfile);
        document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccount);

        // é£Ÿè°±ç®¡ç†
        document.getElementById('searchBtn').addEventListener('click', () => {
            currentPage = 1;
            loadRecipes();
        });
        document.getElementById('sortOrder').addEventListener('change', () => {
            currentPage = 1;
            loadRecipes();
        });
        document.getElementById('searchRecipeIdBtn').addEventListener('click', () => {
            const id = document.getElementById('searchRecipeIdInput').value.trim();
            if (id) {
                selectRecipe(id);
            } else {
                alert('è¯·è¾“å…¥é£Ÿè°±ID');
            }
        });
        document.getElementById('query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                loadRecipes();
            }
        });
        document.getElementById('createRecipeBtn').addEventListener('click', () => {
            showCreateRecipeModal();
        });

        // è¯„è®ºç®¡ç†
        document.getElementById('postCommentBtn').addEventListener('click', postComment);

        // ç”¨æˆ·æœç´¢
        document.getElementById('searchUserBtn').addEventListener('click', searchUser);

        // åŠ¨æ€æµ
        document.getElementById('refreshFeedBtn').addEventListener('click', loadFeed);

        // APIæµ‹è¯•
        document.getElementById('testApiBtn').addEventListener('click', testApi);

        // åˆ†é¡µæ§åˆ¶
        document.getElementById('prevPageBtn').addEventListener('click', prevPage);
        document.getElementById('nextPageBtn').addEventListener('click', nextPage);
        document.getElementById('pageSizeSelect').addEventListener('change', changePageSize);

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });
    });
</script>
</body>
</html>